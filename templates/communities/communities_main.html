{% extends 'base.html' %}
{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/communities_main.css' %}">
{% endblock %}

{% block content %}
    <meta name="csrf-token" content="{{ csrf_token }}">
    <div class="background-b"></div>
    <div class="community-container">
        <h1 class="title">모두의 온기록</h1>
            <div class="header">
            <div class="dropdown">
                <button class="friend-btn" id="friend-btn">반려동물 ▼</button>
                <div class="dropdown-content" id="dropdown-content">
                    <button class="select-option" data-type="pet">반려동물</button>
                    <button class="select-option" data-type="plant">반려식물</button>
                </div>
            </div>
            <a href="{% url 'diaries:view_calendar' %}" class="add-diary-btn">
                온기록 남기기
            </a>
        </div>

        <div class="container">
            <div class="diary-list">
                {% if diaries %}
                    {% for diary in diaries %}
                    <div class="diary-card" data-diary-id="{{ diary.id }}">
                        <a href="{% url 'diaries:detail_diaries' diary.id %}" class="diary-card-link">
                            <div class="diary-image">
                                {% if diary.image %}
                                    <img src="{{ diary.image.url }}" alt="다이어리 이미지">
                                {% else %}
                                    <div class="no-image"></div>
                                {% endif %}
                            </div>
                            <div class="diary-info">
                                <h2 class="diary-title">{{ diary.title }}</h2>
                                <p class="diary-preview">
                                    {{ diary.content|truncatechars:37 }}
                                </p>
                            </div>
                        </a>
                        
                        <div class="diary-actions">
                            {% if diary.is_liked %}
                            <button class="like-btn" data-diary-id="{{ diary.id }}" >
                                <i class="bi bi-heart-fill"></i>
                                <span id="like-count-{{ diary.id }}">{{ diary.like_set.count }}</span>
                            </button>
                            {% else %}
                            <button class="like-btn" data-diary-id="{{ diary.id }}">
                                <i class="bi bi-heart"></i>
                                <span id="like-count-{{ diary.id }}">{{ diary.like_set.count }}</span>
                            </button>
                            {%endif%}
                            <a href="{% url 'diaries:detail_diaries' diary.id %}" class="comment-btn" data-diary-id="{{ diary.id }}">
                                <i class="bi bi-chat-dots"></i>
                                <span id="comment-count-{{ diary.id }}">{{ diary.comment_set.count }}</span>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="text-align: center; color: #999;">등록된 온기록이 없습니다.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const friendBtn = document.getElementById('friend-btn');
            const dropdownContent = document.getElementById('dropdown-content');
        
            // 버튼 클릭 시 드롭다운 표시/숨김
            friendBtn.addEventListener('click', function () {
                dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
            });
        
            // 옵션 선택 시 드롭다운 닫고 버튼 텍스트 변경
            document.querySelectorAll('.select-option').forEach(button => {
                button.addEventListener('click', function () {
                    const selectedType = this.getAttribute('data-type');
                    friendBtn.textContent = selectedType === 'pet' ? '반려동물 ▼' : '반려식물 ▼';
                    dropdownContent.style.display = 'none';
                });
            });
        
            // 드롭다운 외부 클릭 시 숨김 처리
            document.addEventListener('click', function (event) {
                if (!friendBtn.contains(event.target) && !dropdownContent.contains(event.target)) {
                    dropdownContent.style.display = 'none';
                }
            });
        });
        document.addEventListener('DOMContentLoaded', function () {
            // CSRF 토큰 가져오기
            const csrfMetaTag = document.querySelector('meta[name="csrf-token"]');
            const csrfToken = csrfMetaTag ? csrfMetaTag.getAttribute('content') : null;

            document.querySelectorAll('.like-btn').forEach(button => {
                button.addEventListener('click', () => {
                const diaryId = button.getAttribute('data-diary-id');
        
                fetch(`/communities/toggle_like/${diaryId}/`, {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                    }
                })
                .then(response => {
                    if (!response.ok) {
                    throw new Error('좋아요 요청 실패');
                    }
                    return response.json();
                })
                .then(data => {
                    // 좋아요 개수 업데이트
                    document.getElementById(`like-count-${diaryId}`).textContent = `${data.like_count}`;
                    console.log(data);
                    // 버튼 텍스트 변경
                    if (data.status === 'liked') {
                    button.innerHTML = `
                        <i class="bi bi-heart-fill"></i><span id="like-count-${diaryId}">${data.like_count}</span>`;
                    } else {
                    button.innerHTML = 
                        `<i class="bi bi-heart"></i><span id="like-count-${diaryId}">${data.like_count}</span>`;
                    }
                })
                .catch(error => {
                    console.error('좋아요 처리 중 오류:', error);
                    alert('좋아요 처리 중 오류가 발생했습니다.');
                });
                });
            });
            // 댓글 등록 버튼 클릭 이벤트
            document.querySelectorAll('.add-comment-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const diaryId = button.getAttribute('data-diary-id');
                    const commentInput = document.getElementById(`comment-input-${diaryId}`);
                    const commentContent = commentInput.value.trim();

                    if (!commentContent) {
                        alert('댓글을 입력하세요.');
                        return;
                    }

                    fetch(`/communities/add_comment/${diaryId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ comment: commentContent })
                    })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById(`comment-count-${diaryId}`).textContent = data.comment_count;

                        // 댓글 리스트 초기화 후 다시 렌더링
                        const commentsList = document.getElementById(`comments-list-${diaryId}`);
                        commentsList.innerHTML = '';
                        data.whole_comments.forEach(comment => {
                            commentsList.innerHTML += `<li>${comment.comment_user__nickname}: ${comment.content}</li>`;
                        });

                        commentInput.value = '';
                    })
                    .catch(error => {
                        console.error('댓글 추가 중 오류:', error);
                        alert('댓글 추가 중 오류가 발생했습니다.');
                    });
                });
            });
        });
        document.addEventListener('DOMContentLoaded', function () {
            const csrfMetaTag = document.querySelector('meta[name="csrf-token"]');
            const csrfToken = csrfMetaTag ? csrfMetaTag.getAttribute('content') : null;
            
            const friendBtn = document.getElementById('friend-btn');
            const dropdownContent = document.getElementById('dropdown-content');
            
            // 버튼 클릭 시 드롭다운 표시/숨김

        
            // 옵션 선택 시 필터링 요청
            document.querySelectorAll('.select-option').forEach(button => {
                button.addEventListener('click', function () {
                    const selectedType = this.getAttribute('data-type');  // 선택된 타입 (pet/plant)
                    friendBtn.textContent = selectedType === 'pet' ? '반려동물 ▼' : '반려식물 ▼';
        
                    // ✅ AJAX 요청으로 필터링된 데이터 가져오기
                    fetch(`/communities/filter_diaries/?type=${selectedType}`)
                        .then(response => response.json())
                        .then(data => {
                            const diaryList = document.querySelector('.diary-list');
                            diaryList.innerHTML = '';  // 기존 목록 초기화
        
                            if (data.diaries.length === 0) {
                                diaryList.innerHTML = '<p style="text-align: center; color: #999;">등록된 온기록이 없습니다.</p>';
                                return;
                            }
        
                            // ✅ 새로운 다이어리 목록 추가
                            data.diaries.forEach(diary => {
                                diaryList.innerHTML += `
                                    <div class="diary-card" data-diary-id="${diary.id}">
                                        <a href="/diaries/detail_diaries/${diary.id}/" class="diary-card-link">
                                            <div class="diary-image">
                                                ${diary.image_url 
                                                    ? `<img src="${diary.image_url}" alt="다이어리 이미지">`
                                                    : '<div class="no-image"></div>'}
                                            </div>
                                            <div class="diary-info">
                                                <h2 class="diary-title">${diary.title}</h2>
                                                <p class="diary-preview">${diary.content.slice(0, 47)}...</p>
                                            </div>
                                        </a>
                                        <div class="diary-actions">
                                            <button class="like-btn" data-diary-id="${diary.id}">
                                                <i class="bi ${diary.is_liked ? 'bi-heart-fill' : 'bi-heart'}"></i>
                                                <span id="like-count-${diary.id}">${diary.like_count}</span>
                                            </button>
                                            <button class="comment-btn" data-diary-id="${diary.id}">
                                                <i class="bi bi-chat-dots"></i>
                                                <span id="comment-count-${diary.id}">${diary.comment_count}</span>
                                            </button>
                                        </div>
                                    </div>`;
                            });
                        })
                        .catch(error => {
                            console.error('필터링 오류:', error);
                            alert('필터링 중 오류가 발생했습니다.');
                        });
                });
            });
        });
    
    </script>
{% endblock %}